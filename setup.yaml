version: "3"

# All vars required to run setup tasks should be defined here
vars:
  CONFIGS_DIR:
    sh: "echo $HOME/configs"

tasks:
  default:
    cmds:
      - task: dependencies
      - task: link
      - task: macos-configuration
      - task: install-neovim
      - task: install-starship
      - task: download-configs

  dependencies:
    cmds:
      # mac
      - cmd: brew install git stow ripgrep unzip fd fzf tmux watch zoxide croc
        platforms: [darwin]
      - cmd: brew install --cask raycast
        platforms: [darwin]
      - cmd: brew install --cask ghostty
        platforms: [darwin]
      # linux
      - cmd: sudo apt update -y
        platforms: [linux]
      - cmd: sudo apt install -y stow git unzip fd-find fzf watch ripgrep zsh tmux build-essential libfuse2 zoxide
        platforms: [linux]

  link:
    cmds:
      # mac
      - cmd: stow --ignore=".DS_Store" --target $HOME --dir {{.CONFIGS_DIR}} -R mac nvim ansible git mise tmux starship zed lazygit vscode ghostty ssh rclone sops
        platforms: [darwin]
      # linux
      - cmd: stow --ignore=".DS_Store" --target $HOME --dir {{.CONFIGS_DIR}} -R xbindkeys nvim ansible git mise tmux starship zed lazygit ghostty ssh rclone sops
        platforms: [linux]
      # mac obs
      # - cmd: 'ln -sF {{.CONFIGS_DIR}}/obs/basic "$HOME/Library/Application Support/obs-studio/basic"'
      #   platforms: [darwin]
      # windows obs
      # - cmd: fling -i ".DS_Store" -s "%USERPROFILE%\AppData\Roaming\obs-studio\basic" "%USERPROFILE%\configs\obs\basic"
      #   platforms: [windows]

  install-neovim:
    platforms: [darwin, linux]
    cmds:
      # mac
      - cmd: brew install neovim
        platforms: [darwin]
      # linux
      - cmd: mkdir -p $HOME/bin && cd $HOME/bin && curl -L https://github.com/neovim/neovim/releases/latest/download/nvim.appimage -o ~/bin/nvim && chmod u+x ~/bin/nvim
        platforms: [linux]

  install-starship:
    platforms: [darwin, linux]
    cmds:
      # mac
      - cmd: brew install starship
        platforms: [darwin]
      # linux
      - cmd: curl -sL https://starship.rs/install.sh -o ~/install_starship.sh && sh ~/install_starship.sh --yes && rm ~/install_starship.sh
        platforms: [linux]

  download-configs:
    dir: ./
    vars:
      PASS:
        sh: key get "storage - crypt"
    cmds:
      - cmd: rclone sync --crypt-password={{.PASS}} crypt:/ssh ./ssh
        platforms: [darwin, linux]

  macos-configuration:
    platforms: [darwin]
    cmds:
      - defaults write -g InitialKeyRepeat -int 15
      - defaults write -g KeyRepeat -int 1
      - defaults write http://com.apple.finder AppleShowAllFiles YES
