version: "3"

# All vars required to run setup tasks should be defined here
vars:
  upload_dirs: ["/ssh", "/obs"]

tasks:
  default:
    cmds:
      - task: dependencies
      - task: macos-configuration
      - task: install-neovim
      - task: download
      - task: link

  dependencies:
    cmds:
      # mac
      - cmd: brew install git stow ripgrep unzip fd fzf tmux watch zoxide croc
        platforms: [darwin]
      - cmd: brew install --cask raycast
        platforms: [darwin]
      - cmd: brew install --cask ghostty
        platforms: [darwin]
      # linux
      - cmd: sudo apt update -y
        platforms: [linux]
      - cmd: sudo apt install -y stow git unzip fd-find fzf watch ripgrep zsh tmux build-essential libfuse2 zoxide
        platforms: [linux]

  link:
    cmds:
      # mac
      - cmd: stow --ignore=".DS_Store" --target $HOME --dir $CONFIGS_DIR -R mac nvim ansible git mise tmux starship zed lazygit vscode ghostty ssh rclone sops
        platforms: [darwin]
      # linux
      - cmd: stow --ignore=".DS_Store" --target $HOME --dir $CONFIGS_DIR -R nvim ansible git mise tmux starship zed lazygit ghostty ssh rclone sops
        platforms: [linux]
      # mac obs
      # - cmd: 'ln -sF $CONFIGS_DIR/obs/basic "$HOME/Library/Application Support/obs-studio/basic"'
      #   platforms: [darwin]
      # windows obs
      # - cmd: fling -i ".DS_Store" -s "%USERPROFILE%\AppData\Roaming\obs-studio\basic" "%USERPROFILE%\configs\obs\basic"
      #   platforms: [windows]

  macos-configuration:
    platforms: [darwin]
    cmds:
      - defaults write -g InitialKeyRepeat -int 15
      - defaults write -g KeyRepeat -int 1
      - defaults write http://com.apple.finder AppleShowAllFiles YES

  install-neovim:
    platforms: [darwin, linux]
    cmds:
      # mac
      - cmd: brew install neovim
        platforms: [darwin]
      # linux
      - cmd: mkdir -p $HOME/bin && cd $HOME/bin && curl -L https://github.com/neovim/neovim/releases/latest/download/nvim.appimage -o ~/bin/nvim && chmod u+x ~/bin/nvim
        platforms: [linux]

  download:
    dir: ./
    env:
      RCLONE_CRYPT_PASSWORD:
        sh: key get "storage - crypt"
    cmds:
      - for: { var: upload_dirs }
        cmd: rclone sync crypt:{{.ITEM}} .{{.ITEM}}

  upload:
    dir: ./
    env:
      RCLONE_CRYPT_PASSWORD:
        sh: key get "storage - crypt"
    cmds:
      - for: { var: upload_dirs }
        cmd: rclone sync .{{.ITEM}} crypt:{{.ITEM}}

  migrate:
    dir: "$HOME"
    cmds:
      # ssh keys, key .key and sops key need to be migrated manually for a new setup
      - croc send --zip $(gum choose --no-limit .ssh configs/key configs/sops source Downloads Documents)
